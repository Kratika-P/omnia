# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# ===============================================================
# omnia_build_stream Quadlet Service
# FastAPI Service for Omnia Build Stream Automation
# ===============================================================
[Unit]
Description=Omnia Build Stream FastAPI Container
After=omnia_core.service
Requires=omnia_core.service

[Container]
ContainerName={{ build_stream_container_name }}
HostName={{ build_stream_container_name }}
Image={{ build_stream_image_name }}:{{ build_stream_image_tag }}
Network=host

# Environment variables
Environment=HOST={{ admin_ip }}
Environment=PORT={{ build_stream_port }}
Environment=PULP_BASE_URL={{ pulp_base_url }}
Environment=PULP_USERNAME=admin
Environment=PULP_PASSWORD={{ pulp_password }}
Environment=PULP_VERIFY_SSL=true
Environment=REQUESTS_CA_BUNDLE=/etc/pulp/certs/pulp_webserver.crt
Environment=SSL_CERT_FILE=/etc/pulp/certs/pulp_webserver.crt

# Database configuration
Environment=DATABASE_URL=postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost:5432/{{ postgres_db_name }}

# Volume mounts (shared from omnia_core)
Volume={{ omnia_path }}/omnia:/opt/omnia{{ selinux_option }}
Volume={{ build_stream_log_dir }}:/var/log/omnia_build_stream{{ selinux_option }}
Volume={{ build_stream_ssl_dir }}:/etc/ssl/omnia:ro{{ selinux_option }}
Volume={{ build_stream_pulp_cert_host_dir }}:{{ build_stream_pulp_cert_host_dir }}:ro{{ selinux_option }}

[Service]
Restart=always

[Install]
WantedBy=multi-user.target default.target