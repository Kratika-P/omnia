# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---

# Build Stream Container Configuration
core_container_name: "omnia_core"
build_stream_container_name: "omnia_build_stream"

# OIM metadata file path (read from omnia_core container)
oim_metadata_file: "/opt/omnia/.data/oim_metadata.yml"

# Build Stream Image (Docker Hub)
build_stream_dockerhub_registry: "docker.io/dellhpcomniaaisolution"
build_stream_image_name: "{{ build_stream_dockerhub_registry }}/omnia_build_stream"
build_stream_image_tag: "1.0"

# Ports & Logs
build_stream_port: "{{ hostvars['localhost']['build_stream_port'] | default('443') }}"
build_stream_log_dir: "{{ omnia_path }}/log/build_stream"

omnia_default_dir: "/omnia"
# Build Stream watcher service
watcher_service_name: "playbook_watcher.service"
watcher_service_src_path: "templates/playbook_watcher.service.j2"
watcher_systemd_path: "/etc/systemd/system"
# build_stream_watcher_unit_path: "{{ build_stream_watcher_unit_dir }}/{{ build_stream_watcher_service_name }}"
build_stream_watcher_exec: "/usr/bin/python3 {{ oim_shared_path }}/omnia/build_stream/playbook-watcher/playbook_watcher_service.py"
watcher_restart_sec: 5
watcher_no_new_privileges: true
watcher_private_tmp: true
watcher_limit_nofile: 4096
watcher_memory_max: "512M"
watcher_cpu_quota: "50%"

# Watcher environment variables
build_stream_watcher_playbook_queue_base: "{{ oim_shared_path }}/omnia/playbook_queue"
watcher_poll_interval_seconds: 2
watcher_max_concurrent_jobs: 5
watcher_default_timeout_minutes: 30
watcher_log_level: "INFO"

# Directory & File Modes
build_stream_dir_mode: "0755"
build_stream_jwt_script_mode: "0755"

# SSL certificate configuration for build_stream
build_stream_ssl_dir: "/opt/omnia/build_stream/ssl"
build_stream_ssl_cert: "{{ build_stream_ssl_dir }}/cert.pem"
build_stream_ssl_key: "{{ build_stream_ssl_dir }}/key.pem"
build_stream_ssl_days: 365
build_stream_ssl_file_mode: "0600"

# JWT key configuration
build_stream_jwt_keys_script: "/opt/omnia/build_stream/scripts/generate_jwt_keys.sh"
build_stream_jwt_keys_dir: "/opt/omnia/build_stream/api/auth/keys"

# Project configuration
build_stream_default_file: "/opt/omnia/input/default.yml"
build_stream_project_default: "project_default"
build_stream_project_build_stream: "project_build_stream"

# Pulp certificate configuration
# Cert that build_stream will verify against
build_stream_pulp_cert_host_dir: "/etc/pulp/certs"
build_stream_pulp_cert_dest: "/etc/pulp"
build_stream_pulp_cert_container_path: "/etc/pulp/certs/pulp_webserver.crt"

# Cert inside pulp container (source)
pulp_container_name: "pulp"

# Pulp server URL
admin_ip: "{{ hostvars['localhost']['admin_ip'] | default('localhost') }}"
pulp_base_url: "https://{{ admin_ip }}:2225"
pulp_username: "admin"
pulp_password: ""

# Quadlet
quadlet_dir: "/etc/containers/systemd"
build_stream_quadlet_path: "{{ quadlet_dir }}/{{ build_stream_container_name }}.container"
build_stream_quadlet_file_mode: "0644"

# PostgreSQL configuration (from postgres role)
postgres_user: "{{ hostvars['localhost']['postgres_user'] }}"
postgres_password: "{{ hostvars['localhost']['postgres_password'] }}"
postgres_db_name: "{{ hostvars['localhost']['postgres_db_name'] | default('build_stream_db') }}"

# Systemd service name generated by Quadlet
build_stream_service: "{{ build_stream_container_name }}.service"

# Health check
build_stream_health_endpoint: "https://{{ admin_ip }}:{{ build_stream_port }}/health"
container_ready_wait_seconds: 5
bs_container_wait_retries: 30
bs_container_wait_delay: 2
health_check_retries: 30
health_check_delay: 5
health_check_status_code: 200

# Firewall configuration
build_stream_firewall_port: "{{ build_stream_port }}/tcp"

# User messages
build_stream_image_pull_success_msg:
  - "Successfully pulled image from Docker Hub"
  - "Image: {{ build_stream_image_name }}:{{ build_stream_image_tag }}"

build_stream_container_failure_msg: |
  The deployment of the {{ build_stream_container_name }} container has failed. To resolve this issue,
  please run the utility/oim_cleanup.yml playbook to clean up any existing OIM resources.
  After the cleanup, you can re-run the original playbook to deploy the {{ build_stream_container_name }} container successfully.

build_stream_pulp_not_ready_msg: |
  Pulp container '{{ pulp_container_name }}' is not ready.
  Exists={{ (pulp_container_info.containers | length) > 0 }},
  State={{ (pulp_container_info.containers[0].State.Status
           if (pulp_container_info.containers | length) > 0 else 'missing') }}.
  Run oim_cleanup and re-run prepare_oim.yml.

build_stream_https_failure_msg: |
  HTTPS connectivity to Pulp failed from build_stream.
  HTTP={{ curl_status.stdout | trim }}.
  Since SAN contains DNS:{{ admin_ip }}, ensure pulp_base_url is https://{{ admin_ip }}:2225 (current={{ pulp_base_url }}).
