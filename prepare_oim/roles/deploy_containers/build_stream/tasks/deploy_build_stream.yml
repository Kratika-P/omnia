# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
# -------------------------------------------------------------------
# 0) Stop/disable existing build_stream systemd service and remove container
# -------------------------------------------------------------------
- name: Check if omnia_build_stream service exists
  ansible.builtin.systemd_service:
    name: "{{ build_stream_container_name }}.service"
  register: build_stream_service_status
  failed_when: false
  changed_when: false

- name: Stop and disable omnia_build_stream service if present
  ansible.builtin.systemd_service:
    name: "{{ build_stream_container_name }}.service"
    state: stopped
    enabled: false
  when: build_stream_service_status.status is defined
  failed_when: false

- name: Check if omnia_build_stream container exists
  containers.podman.podman_container_info:
    name: "{{ build_stream_container_name }}"
  register: existing_container_info
  failed_when: false
  changed_when: false

- name: Remove existing omnia_build_stream container if present
  containers.podman.podman_container:
    name: "{{ build_stream_container_name }}"
    state: absent
  when: existing_container_info.containers | length > 0

# -------------------------------------------------------------------
# 1) Get metadata/config from omnia_core
# -------------------------------------------------------------------
- name: Get metadata from omnia_core
  containers.podman.podman_container_exec:
    name: "omnia_core"
    command: "cat {{ oim_metadata_file }}"
  register: metadata_content
  changed_when: false

- name: Extract configuration from metadata
  ansible.builtin.set_fact:
    omnia_path: "{{ metadata_content.stdout | regex_search('oim_shared_path:\\s*(\\S+)', '\\1') | first }}"
    share_option: "{{ metadata_content.stdout | regex_search('omnia_share_option:\\s*(\\S+)', '\\1') | first | default('') }}"
    nfs_type: "{{ metadata_content.stdout | regex_search('nfs_type:\\s*(\\S+)', '\\1') | first | default('') }}"
    pulp_password: "{{ hostvars['localhost']['pulp_password'] }}"
    postgres_user: "{{ hostvars['localhost']['postgres_user'] }}"
    postgres_password: "{{ hostvars['localhost']['postgres_password'] }}"
    postgres_db_name: "{{ hostvars['localhost']['postgres_db_name'] }}"
  no_log: true

# -------------------------------------------------------------------
# 2) FAIL if Pulp container missing / not running
# -------------------------------------------------------------------
- name: Precheck - fail if Pulp container is missing or not running
  block:
    - name: Ensure pulp container exists
      containers.podman.podman_container_info:
        name: "{{ pulp_container_name }}"
      register: pulp_container_info

    - name: Fail if Pulp container is missing OR not running
      ansible.builtin.fail:
        msg: "{{ build_stream_pulp_not_ready_msg }}"
      when: >
        (pulp_container_info.containers | length == 0) or
        (pulp_container_info.containers[0].State.Status != "running")

# -------------------------------------------------------------------
# 3) Copy Pulp certificate from pulp container -> host persistent path (checksum-aware)
# -------------------------------------------------------------------
- name: Verify Pulp cert exists inside pulp container
  containers.podman.podman_container_exec:
    name: "{{ pulp_container_name }}"
    command:
      - test
      - -f
      - "{{ pulp_cert_src_path }}"
  register: pulp_cert_check
  changed_when: false

- name: Ensure host directory for Pulp cert exists
  ansible.builtin.file:
    path: "{{ build_stream_pulp_cert_host_dir }}"
    state: directory
    mode: "{{ build_stream_pulp_cert_host_dir_mode }}"

- name: Get pulp cert inside pulp container
  containers.podman.podman_container_exec:
    name: "{{ pulp_container_name }}"
    command:
      - sha256sum
      - "{{ pulp_cert_src_path }}"
  register: pulp_cert_sha
  changed_when: false

- name: Get host pulp cert if present
  ansible.builtin.stat:
    path: "{{ build_stream_pulp_cert_host_path }}"
    checksum_algorithm: sha256
  register: host_cert_stat

- name: Copy pulp cert to host if missing/changed
  containers.podman.podman_container_copy:
    container: "{{ pulp_container_name }}"
    src: "{{ pulp_cert_src_path }}"
    dest: "{{ build_stream_pulp_cert_host_path }}"
    force: true                 
  when: (not host_cert_stat.stat.exists) or
        (host_cert_stat.stat.checksum != pulp_cert_sha.stdout.split()[0])

- name: Ensure host cert permissions
  ansible.builtin.file:
    path: "{{ build_stream_pulp_cert_host_path }}"
    owner: root
    group: root
    mode: "{{ build_stream_pulp_cert_host_file_mode }}"

# -------------------------------------------------------------------
# 4) Deploy quadlet using template + restart via handlers
# -------------------------------------------------------------------
- name: Ensure quadlet directory exists
  ansible.builtin.file:
    path: "{{ quadlet_dir }}"
    state: directory
    mode: "{{ quadlet_dir_mode }}"

- name: Deploy build_stream quadlet file from template
  ansible.builtin.template:
    src: "build_stream.j2"
    dest: "{{ build_stream_quadlet_path }}"
    mode: "{{ build_stream_quadlet_file_mode }}"
  notify:
    - Reload systemd
    - Restart build_stream

- name: Reset failed state (clears start-limit-hit)
  ansible.builtin.command: "systemctl reset-failed {{ build_stream_service }}"
  changed_when: false
  failed_when: false

- name: Enable and start build_stream service
  ansible.builtin.systemd_service:
    name: "{{ build_stream_service }}"
    enabled: true
    state: started

# Ensure restart happens before validation
- name: Apply systemd reload/restart now
  ansible.builtin.meta: flush_handlers

- name: Wait for container readiness
  ansible.builtin.pause:
    seconds: "{{ container_ready_wait_seconds | default(5) }}"

# -------------------------------------------------------------------
# 5) Validate HTTPS connectivity from inside build_stream
# -------------------------------------------------------------------
- name: Test HTTPS connectivity from build_stream to Pulp (expect HTTP 200)
  containers.podman.podman_container_exec:
    name: "{{ build_stream_container_name }}"
    command:
      - sh
      - -lc
      - >
        curl -sS -o /dev/null -w '%{http_code}\n'
        --cacert {{ build_stream_pulp_cert_container_path }}
        {{ pulp_base_url }}/pulp/api/v3/status/
  register: curl_status
  changed_when: false

- name: Fail if HTTPS test is not 200
  ansible.builtin.fail:
    msg: "{{ build_stream_https_failure_msg}}"
  when: (curl_status.stdout | trim) != "200"

# -------------------------------------------------------------------
# 6) Validate health API endpoint https://localhost:{{ build_stream_port }}/health"
# -------------------------------------------------------------------
- name: Verify build_stream health endpoint (FastAPI)
  ansible.builtin.uri:
    url: "{{ build_stream_health_endpoint }}"
    method: GET
    status_code: "{{ health_check_status_code }}"
    validate_certs: false
  register: bs_health
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  until: bs_health.status == health_check_status_code
