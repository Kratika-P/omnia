# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
# -------------------------------------------------------------------
# 0) Stop/disable existing build_stream systemd service and remove container
# -------------------------------------------------------------------
- name: Check if omnia_build_stream service exists
  ansible.builtin.systemd_service:
    name: "{{ build_stream_container_name }}.service"
  register: build_stream_service_status
  failed_when: false
  changed_when: false

- name: Stop and disable omnia_build_stream service if present
  ansible.builtin.systemd_service:
    name: "{{ build_stream_container_name }}.service"
    state: stopped
    enabled: false
  when: build_stream_service_status.status is defined
  failed_when: false

- name: Check if omnia_build_stream container exists
  containers.podman.podman_container_info:
    name: "{{ build_stream_container_name }}"
  register: existing_container_info
  failed_when: false
  changed_when: false

- name: Remove existing omnia_build_stream container if present
  containers.podman.podman_container:
    name: "{{ build_stream_container_name }}"
    state: absent
  when: existing_container_info.containers | length > 0

# -------------------------------------------------------------------
# 1) Get metadata/config from omnia_core
# -------------------------------------------------------------------
- name: Get metadata from omnia_core
  containers.podman.podman_container_exec:
    name: "omnia_core"
    command: cat {{ oim_metadata_file }}
  register: metadata_content
  changed_when: false

- name: Extract configuration from metadata
  ansible.builtin.set_fact:
    omnia_path: "{{ metadata_content.stdout | regex_search('oim_shared_path:\\s*(\\S+)', '\\1') | first }}"
    share_option: "{{ metadata_content.stdout | regex_search('omnia_share_option:\\s*(\\S+)', '\\1') | first | default('') }}"
    nfs_type: "{{ metadata_content.stdout | regex_search('nfs_type:\\s*(\\S+)', '\\1') | first | default('') }}"
    pulp_password: "{{ hostvars['localhost']['pulp_password'] }}"
    postgres_user: "{{ hostvars['localhost']['postgres_user'] }}"
    postgres_password: "{{ hostvars['localhost']['postgres_password'] }}"
    postgres_db_name: "{{ hostvars['localhost']['postgres_db_name'] }}"
  no_log: true

# -------------------------------------------------------------------
# 2) FAIL if Pulp container missing / not running
# -------------------------------------------------------------------
- name: Precheck - fail if Pulp container is missing or not running
  block:
    - name: Ensure pulp container exists
      containers.podman.podman_container_info:
        name: "{{ pulp_container_name }}"
      register: pulp_container_info

    - name: Fail if Pulp container is missing OR not running
      ansible.builtin.fail:
        msg: "{{ build_stream_pulp_not_ready_msg }}"
      when: >
        (pulp_container_info.containers | length == 0) or
        (pulp_container_info.containers[0].State.Status != "running")

# -------------------------------------------------------------------
# 3) Copy Pulp certificate from pulp container -> host
# -------------------------------------------------------------------
- name: Ensure host pulp cert directory exists
  ansible.builtin.file:
    path: /etc/pulp/certs
    state: directory
    owner: root
    group: root
    mode: "{{ build_stream_dir_mode }}"

- name: Copy entire pulp cert directory from Pulp container to host
  containers.podman.podman_container_copy:
    container: "{{ pulp_container_name }}"
    src: "/etc/pulp/certs"
    dest: "/etc/pulp/"
    from_container: true
    overwrite: true
  register: pulp_copy_dir

- name: Ensure host cert directory permissions
  ansible.builtin.file:
    path: /etc/pulp/certs
    owner: root
    group: root
    mode: "{{ build_stream_dir_mode }}"

# -------------------------------------------------------------------
# 4) Deploy quadlet using template + restart via handlers
# -------------------------------------------------------------------
- name: Ensure quadlet directory exists
  ansible.builtin.file:
    path: "{{ quadlet_dir }}"
    state: directory
    mode: "{{ build_stream_dir_mode }}"

- name: Deploy build_stream quadlet file from template
  ansible.builtin.template:
    src: "build_stream.j2"
    dest: "{{ build_stream_quadlet_path }}"
    mode: "{{ build_stream_quadlet_file_mode }}"
  notify:
    - Reload systemd
    - Restart build_stream

- name: Enable and start build_stream service
  ansible.builtin.systemd_service:
    name: "{{ build_stream_service }}"
    enabled: true
    state: started

# Ensure restart happens before validation
- name: Apply systemd reload/restart now
  ansible.builtin.meta: flush_handlers

- name: Wait until omnia_build_stream container exists and is running
  containers.podman.podman_container_info:
    name: "{{ build_stream_container_name }}"
  register: bs_info
  retries: 30
  delay: 2
  until:
    - bs_info.containers is defined
    - bs_info.containers | length > 0
    - bs_info.containers[0].State is defined
    - bs_info.containers[0].State.Running | bool

# -------------------------------------------------------------------
# 5) Validate HTTPS connectivity from inside build_stream
# -------------------------------------------------------------------
- name: Build curl command
  ansible.builtin.set_fact:
    curl_cmd:
      - curl
      - -sS
      - -o
      - /dev/null
      - -w
      - "%{http_code}\n"
      - --cacert
      - "{{ build_stream_pulp_cert_container_path }}"
      - "{{ pulp_base_url }}/pulp/api/v3/status/"
  changed_when: false

- name: Test HTTPS from build_stream to Pulp (exec)
  containers.podman.podman_container_exec:
    name: "{{ build_stream_container_name }}"
    argv: "{{ curl_cmd }}"
  register: curl_status
  changed_when: false
  failed_when: false

- name: Fail if HTTPS test is not 200
  ansible.builtin.fail:
    msg: "{{ build_stream_https_failure_msg }}"
  when: (curl_status.stdout | trim) != "200"

# -------------------------------------------------------------------
# 6) Validate health API endpoint https://localhost:{{ build_stream_port }}/health"
# -------------------------------------------------------------------
- name: Wait until omnia_build_stream container exists and is running
  containers.podman.podman_container_info:
    name: "{{ build_stream_container_name }}"
  register: bs_info
  retries: 30
  delay: 2
  until:
    - bs_info.containers is defined
    - bs_info.containers | length > 0
    - bs_info.containers[0].State is defined
    - bs_info.containers[0].State.Running | bool
