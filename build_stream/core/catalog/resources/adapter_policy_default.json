{
  "version": "2.0.0",
  "description": "Target-centric mapping spec: pull roles into each target file, then derive common roles and remove duplicates.",
  "architectures": ["aarch64", "x86_64"],
  "targets": {
    "default_packages.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "base_os.json",
          "pulls": [
            {"source_key": "Base OS", "target_key": "default_packages"}
          ]
        }
      ]
    },
    "admin_debug_packages.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "base_os.json",
          "pulls": [
            {"source_key": "Base OS", "target_key": "admin_debug_packages"}
          ]
        }
      ]
    },
    "openldap.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "base_os.json",
          "pulls": [
            {
              "source_key": "Base OS",
              "target_key": "openldap",
              "filter": {
                "type": "any_of",
                "filters": [
                  {
                    "type": "allowlist",
                    "field": "package",
                    "values": ["openldap", "openldap-clients", "openldap-servers"],
                    "case_sensitive": false
                  },
                  {
                    "type": "field_in",
                    "field": "feature",
                    "values": ["openldap"],
                    "case_sensitive": false
                  },
                  {
                    "type": "substring",
                    "field": "package",
                    "values": ["ldap", "openldap", "slapd"],
                    "case_sensitive": false
                  }
                ]
              }
            }
          ]
        }
      ]
    },
    "ucx.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "functional_layer.json",
          "pulls": [
            {"source_key": "login_compiler_node_x86_64", "target_key": "login_compiler_node"},
            {"source_key": "login_compiler_node_aarch64", "target_key": "login_compiler_node"}
          ]
        }
      ]
    },
    "openmpi.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "functional_layer.json",
          "pulls": [
            {"source_key": "login_compiler_node_x86_64", "target_key": "login_compiler_node"},
            {"source_key": "login_compiler_node_aarch64", "target_key": "login_compiler_node"}
          ]
        }
      ]
    },
    "ldms.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "functional_layer.json",
          "pulls": [
            {"source_key": "login_compiler_node_x86_64", "target_key": "login_compiler_node"},
            {"source_key": "login_compiler_node_aarch64", "target_key": "login_compiler_node"}
          ]
        }
      ]
    },
    "service_k8s.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "functional_layer.json",
          "pulls": [
            {"source_key": "service_kube_control_plane_x86_64", "target_key": "service_kube_control_plane"},
            {"source_key": "service_kube_node_x86_64", "target_key": "service_kube_node"}
          ]
        }
      ],
      "derived": [
        {
          "target_key": "service_k8s",
          "operation": {
            "type": "extract_common",
            "from_keys": ["service_kube_control_plane", "service_kube_node"],
            "min_occurrences": 2,
            "remove_from_sources": true
          }
        }
      ]
    },
    "slurm_custom.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "functional_layer.json",
          "pulls": [
            {"source_key": "login_node_x86_64", "target_key": "login_node"},
            {"source_key": "login_node_aarch64", "target_key": "login_node"},
            {"source_key": "login_compiler_node_x86_64", "target_key": "login_compiler_node"},
            {"source_key": "login_compiler_node_aarch64", "target_key": "login_compiler_node"},
            {"source_key": "slurm_control_node_x86_64", "target_key": "slurm_control_node"},
            {"source_key": "slurm_node_x86_64", "target_key": "slurm_node"},
            {"source_key": "slurm_node_aarch64", "target_key": "slurm_node"}
          ]
        }
      ],
      "derived": [
        {
          "target_key": "slurms_custom",
          "operation": {
            "type": "extract_common",
            "from_keys": ["login_node", "login_compiler_node", "slurm_control_node", "slurm_node"],
            "min_occurrences": 2,
            "remove_from_sources": true
          }
        }
      ]
    },
    "additional_packages.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "functional_layer.json",
          "pulls": [
            {"source_key": "login_node_x86_64", "target_key": "login_node"},
            {"source_key": "login_node_aarch64", "target_key": "login_node"},
            {"source_key": "login_compiler_node_x86_64", "target_key": "login_compiler_node"},
            {"source_key": "login_compiler_node_aarch64", "target_key": "login_compiler_node"},
            {"source_key": "slurm_control_node_x86_64", "target_key": "slurm_control_node"},
            {"source_key": "slurm_node_x86_64", "target_key": "slurm_node"},
            {"source_key": "slurm_node_aarch64", "target_key": "slurm_node"},
            {"source_key": "service_kube_control_plane_x86_64", "target_key": "service_kube_control_plane"},
            {"source_key": "service_kube_node_x86_64", "target_key": "service_kube_node"}
          ]
        }
      ]
    },
    "csi_driver_powerscale.json": {
      "transform": {
        "exclude_fields": ["architecture"]
      },
      "sources": [
        {
          "source_file": "infrastructure.json",
          "pulls": [
            {"source_key": "csi", "target_key": "csi_driver_powerscale"}
          ]
        }
      ]
    }
  }
}
