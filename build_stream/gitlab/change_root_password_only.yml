# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

- name: Change GitLab Root Password Only
  hosts: gitlab_server
  gather_facts: false
  vars:
    # GitLab configuration
    gitlab_host: "{{ gitlab_host | default('localhost') }}"
    gitlab_use_https: "{{ gitlab_use_https | default(true) }}"
    gitlab_external_url_computed: "{{ 'https' if gitlab_use_https else 'http' }}://{{ gitlab_host }}"
    gitlab_ctl_command: "{{ gitlab_ctl_command | default('gitlab-ctl') }}"

  tasks:
    - name: Validate root password configuration
      ansible.builtin.assert:
        that:
          - hostvars['localhost']['gitlab_root_password'] is defined
          - hostvars['localhost']['gitlab_root_password'] | length > 0
          - hostvars['localhost']['gitlab_root_password'] != ""
        fail_msg: "gitlab_root_password must be defined and non-empty when password change is requested"
        no_log: true

    - name: Set root password fact from localhost
      ansible.builtin.set_fact:
        gitlab_root_password: "{{ hostvars['localhost']['gitlab_root_password'] }}"
      no_log: true

    - name: Change GitLab root password securely
      block:
        - name: Change root password via Rails runner (fast method)
          ansible.builtin.shell: |
            gitlab-rails runner "
              user = User.find_by_username('root')
              if user
                user.password = '{{ gitlab_root_password }}'
                user.password_confirmation = '{{ gitlab_root_password }}'
                user.save!
                puts 'PASSWORD_CHANGED_SUCCESSFULLY'
              else
                puts 'ROOT_USER_NOT_FOUND'
              end
            "
          register: password_change_result
          changed_when: "'PASSWORD_CHANGED_SUCCESSFULLY' in password_change_result.stdout"
          failed_when: "'ROOT_USER_NOT_FOUND' in password_change_result.stdout or password_change_result.rc != 0"
          no_log: true

        - name: Verify password change success
          ansible.builtin.assert:
            that:
              - "'PASSWORD_CHANGED_SUCCESSFULLY' in password_change_result.stdout"
            fail_msg: "Failed to change GitLab root password via Rails runner"
            success_msg: "GitLab root password changed successfully via Rails runner"

        - name: Wait 30 seconds for password to take effect
          ansible.builtin.pause:
            seconds: 30
            prompt: "Waiting for password change to take effect..."

        - name: Verify new password works via Rails validation
          ansible.builtin.shell: |
            gitlab-rails runner "
              user = User.find_by_username('root')
              if user && user.valid_password?('{{ gitlab_root_password }}')
                puts 'PASSWORD_VALIDATION_SUCCESSFUL'
              else
                puts 'PASSWORD_VALIDATION_FAILED'
              end
            "
          register: rails_password_validation
          no_log: true

        - name: Display verification result
          ansible.builtin.debug:
            msg: "Password validation result: {{ rails_password_validation.stdout }}"

        - name: Final verification
          ansible.builtin.assert:
            that:
              - "'PASSWORD_VALIDATION_SUCCESSFUL' in rails_password_validation.stdout"
            fail_msg: "GitLab root password verification failed. Rails validation: {{ rails_password_validation.stdout }}"
            success_msg: "GitLab root password verification successful!"

        - name: Store credentials securely
          ansible.builtin.copy:
            content: |
              GitLab Root Access
              =================
              Username: root
              Password: {{ gitlab_root_password }}
              URL: {{ gitlab_external_url_computed }}
              Changed: {{ ansible_date_time.iso8601 }}
              Status: Active
            dest: "/root/.gitlab_root_access"
            mode: '0600'
            owner: root
            group: root
          no_log: true

        - name: Display success message
          ansible.builtin.debug:
            msg:
              - "============================================"
              - "   GitLab Root Password Change Complete      "
              - "============================================"
              - ""
              - "GitLab URL: {{ gitlab_external_url_computed }}"
              - "Username: root"
              - "Password: [CONFIGURED - See /root/.gitlab_root_access]"
              - ""
              - "Credentials saved to: /root/.gitlab_root_access"
              - "============================================"

      rescue:
        - name: Handle password change failure
          ansible.builtin.fail:
            msg: "Failed to change GitLab root password. Check system logs for details."
