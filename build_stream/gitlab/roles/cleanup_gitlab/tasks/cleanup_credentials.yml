# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

- name: Remove GitLab initial root password file only
  ansible.builtin.file:
    path: "{{ gitlab_initial_root_password_path }}"
    state: absent
  failed_when: false

- name: Remove GitLab old password files (keep prompting system intact)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ gitlab_old_password_files }}"
  failed_when: false

- name: Note about password prompting system
  ansible.builtin.debug:
    msg: "{{ gitlab_password_cleanup_note }}"

- name: Remove GitLab SSH known hosts entries (cleanup)
  ansible.builtin.command: "ssh-keygen -R {{ gitlab_host | default('localhost') }}"
  when: gitlab_host is defined
  changed_when: false
  failed_when: false

- name: Remove GitLab SSH keys (cleanup)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ gitlab_ssh_host_key_files }}"
  failed_when: false

- name: Remove GitLab database encryption keys (cleanup)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ gitlab_database_encryption_key_files }}"
  failed_when: false

- name: Clear GitLab root password from Omnia credentials file
  delegate_to: localhost
  run_once: true
  block:
    - name: Set credential file paths
      ansible.builtin.set_fact:
        omnia_cred_file: "{{ hostvars['localhost']['input_project_dir'] }}/omnia_config_credentials.yml"
        omnia_cred_vault_file: "{{ hostvars['localhost']['input_project_dir'] }}/.omnia_config_credentials_key"

    - name: Check if Omnia credential file exists
      ansible.builtin.stat:
        path: "{{ omnia_cred_file }}"
      register: omnia_cred_stat

    - name: Check if Omnia credential file is vault-encrypted
      ansible.builtin.command: "head -n 1 {{ omnia_cred_file }}"
      register: omnia_cred_header
      changed_when: false
      failed_when: false
      when: omnia_cred_stat.stat.exists

    - name: Check if vault password file exists
      ansible.builtin.stat:
        path: "{{ omnia_cred_vault_file }}"
      register: omnia_cred_vault_stat
      when: omnia_cred_stat.stat.exists

    - name: Decrypt Omnia credential file
      ansible.builtin.command: >-
        ansible-vault decrypt
        --vault-password-file {{ omnia_cred_vault_file }}
        {{ omnia_cred_file }}
      changed_when: false
      failed_when: false
      when:
        - omnia_cred_stat.stat.exists
        - omnia_cred_header.stdout is defined
        - "'ANSIBLE_VAULT' in omnia_cred_header.stdout"
        - omnia_cred_vault_stat.stat.exists

    - name: Blank gitlab_root_password in Omnia credential file
      ansible.builtin.lineinfile:
        path: "{{ omnia_cred_file }}"
        regexp: '^gitlab_root_password:'
        line: 'gitlab_root_password: ""'
        create: false
      failed_when: false
      when: omnia_cred_stat.stat.exists

    - name: Encrypt Omnia credential file
      ansible.builtin.command: >-
        ansible-vault encrypt
        --vault-password-file {{ omnia_cred_vault_file }}
        {{ omnia_cred_file }}
      changed_when: false
      failed_when: false
      when:
        - omnia_cred_stat.stat.exists
        - omnia_cred_header.stdout is defined
        - "'ANSIBLE_VAULT' in omnia_cred_header.stdout"
        - omnia_cred_vault_stat.stat.exists
