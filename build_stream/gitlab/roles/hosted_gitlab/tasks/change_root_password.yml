# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

- name: Validate root password configuration
  ansible.builtin.assert:
    that:
      - hostvars['localhost']['gitlab_root_password'] is defined
      - hostvars['localhost']['gitlab_root_password'] | length > 0
      - hostvars['localhost']['gitlab_root_password'] != ""
    fail_msg: "gitlab_root_password must be defined and non-empty when password change is requested"
    success_msg: "Root password configuration validated"
  no_log: true

- name: Set root password fact from localhost
  ansible.builtin.set_fact:
    gitlab_root_password: "{{ hostvars['localhost']['gitlab_root_password'] }}"
  no_log: true

- name: Change GitLab root password securely
  when: gitlab_root_password is defined and gitlab_root_password | length > 0
  block:
    - name: Change root password via Rails runner (fast method)
      ansible.builtin.shell: |
        gitlab-rails runner "
          user = User.find_by_username('root')
          if user
            user.password = '{{ gitlab_root_password }}'
            user.password_confirmation = '{{ gitlab_root_password }}'
            user.save!
            puts 'PASSWORD_CHANGED_SUCCESSFULLY'
          else
            puts 'ROOT_USER_NOT_FOUND'
          end
        "
      register: password_change_result
      changed_when: "'PASSWORD_CHANGED_SUCCESSFULLY' in password_change_result.stdout"
      failed_when: "'ROOT_USER_NOT_FOUND' in password_change_result.stdout or password_change_result.rc != 0"
      no_log: true

    - name: Verify password change success
      ansible.builtin.assert:
        that:
          - "'PASSWORD_CHANGED_SUCCESSFULLY' in password_change_result.stdout"
        fail_msg: "Failed to change GitLab root password via Rails runner"
        success_msg: "GitLab root password changed successfully via Rails runner"

    - name: Wait 60 seconds for password to take effect
      ansible.builtin.pause:
        seconds: 60
        prompt: "Waiting for password change to take effect..."

    - name: Test password with curl command (alternative verification)
      ansible.builtin.shell: |
        curl -k -s -u "root:{{ gitlab_root_password }}" \
             "{{ gitlab_external_url_computed }}/api/v4/version" | \
             jq -r '.version' 2>/dev/null || echo "FAILED"
      register: curl_password_test
      no_log: true

    - name: Display curl test result
      ansible.builtin.debug:
        msg: "Curl password test result: {{ curl_password_test.stdout }}"

    - name: Debug - show password verification task status
      ansible.builtin.debug:
        msg: "About to run password verification task. This should not fail the playbook."

    - name: Verify new password works with basic auth
      ansible.builtin.uri:
        url: "{{ gitlab_external_url_computed }}/api/v4/version"
        method: GET
        url_username: "root"
        url_password: "{{ gitlab_root_password }}"
        force_basic_auth: true
        validate_certs: false
        status_code: 200
      register: password_verification
      failed_when: false  # Don't fail the playbook, just capture the result
      no_log: true

    - name: Debug - show what happened with API verification
      ansible.builtin.debug:
        msg: "API verification completed with status: {{ password_verification.status | default('UNKNOWN') }}"

    - name: Alternative verification - check user via Rails runner
      ansible.builtin.shell: |
        gitlab-rails runner "
          user = User.find_by_username('root')
          if user && user.valid_password?('{{ gitlab_root_password }}')
            puts 'PASSWORD_VALIDATION_SUCCESSFUL'
          else
            puts 'PASSWORD_VALIDATION_FAILED'
          end
        "
      register: rails_password_validation
      no_log: true

    - name: Display verification results
      ansible.builtin.debug:
        msg: |
          Password Verification Results:
          - API Basic Auth: {{ 'SUCCESS' if password_verification.status == 200 else 'FAILED (Status: ' ~ (password_verification.status | default('N/A')) ~ ')' }}
          - Rails Validation: {{ rails_password_validation.stdout | default('NOT_RUN') }}

    - name: Final verification - Rails validation is authoritative
      ansible.builtin.assert:
        that:
          - "'PASSWORD_VALIDATION_SUCCESSFUL' in rails_password_validation.stdout"
        fail_msg: "GitLab root password verification failed. Rails validation: {{ rails_password_validation.stdout | default('NOT_RUN') }}"
        success_msg: "GitLab root password verification successful! Password change confirmed via Rails validation."

    - name: Store credentials securely
      ansible.builtin.copy:
        content: |
          GitLab Root Access
          =================
          Username: root
          Password: {{ gitlab_root_password }}
          URL: {{ gitlab_external_url_computed }}
          Changed: {{ ansible_date_time.iso8601 }}
          Status: Active
        dest: "/root/.gitlab_root_access"
        mode: '0600'
        owner: root
        group: root
      no_log: true

    - name: Set secure permissions on credential file
      ansible.builtin.file:
        path: "/root/.gitlab_root_access"
        mode: '0600'
        owner: root
        group: root

  rescue:
    - name: Handle password change failure
      ansible.builtin.fail:
        msg: "Failed to change GitLab root password. Check system logs for details."

# Separate verification block outside the main block/rescue
- name: Verify password change success
  when: gitlab_root_password is defined and gitlab_root_password | length > 0
  block:
    - name: Debug - show password verification task status
      ansible.builtin.debug:
        msg: "About to run password verification task. This should not fail the playbook."

    - name: Verify new password works with basic auth
      ansible.builtin.uri:
        url: "{{ gitlab_external_url_computed }}/api/v4/version"
        method: GET
        url_username: "root"
        url_password: "{{ gitlab_root_password }}"
        force_basic_auth: true
        validate_certs: false
        status_code: 200
      register: password_verification
      failed_when: false  # Don't fail the playbook, just capture the result
      no_log: true

    - name: Debug - show what happened with API verification
      ansible.builtin.debug:
        msg: "API verification completed with status: {{ password_verification.status | default('UNKNOWN') }}"

    - name: Alternative verification - check user via Rails runner
      ansible.builtin.shell: |
        gitlab-rails runner "
          user = User.find_by_username('root')
          if user && user.valid_password?('{{ gitlab_root_password }}')
            puts 'PASSWORD_VALIDATION_SUCCESSFUL'
          else
            puts 'PASSWORD_VALIDATION_FAILED'
          end
        "
      register: rails_password_validation
      no_log: true

    - name: Display verification results
      ansible.builtin.debug:
        msg: |
          Password Verification Results:
          - API Basic Auth: {{ 'SUCCESS' if password_verification.status == 200 else 'FAILED (Status: ' ~ (password_verification.status | default('N/A')) ~ ')' }}
          - Rails Validation: {{ rails_password_validation.stdout | default('NOT_RUN') }}

    - name: Final verification - Rails validation is authoritative
      ansible.builtin.assert:
        that:
          - "'PASSWORD_VALIDATION_SUCCESSFUL' in rails_password_validation.stdout"
        fail_msg: "GitLab root password verification failed. Rails validation: {{ rails_password_validation.stdout | default('NOT_RUN') }}"
        success_msg: "GitLab root password verification successful! Password change confirmed via Rails validation."
