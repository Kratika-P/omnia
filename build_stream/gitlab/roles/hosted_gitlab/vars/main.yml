# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
# GitLab Omnibus paths
gitlab_rb_path: "/etc/gitlab/gitlab.rb"
gitlab_ctl_command: "gitlab-ctl"
gitlab_repo_file_path: "/etc/yum.repos.d/gitlab_gitlab-ce.repo"

# Omnibus package
gitlab_package_name: "gitlab-ce-18.8.0"
gitlab_package_state: "present"
gitlab_repo_script_url: "https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh"

# Timeouts
gitlab_startup_wait_minutes: 5
gitlab_health_check_retries: 5
gitlab_health_check_delay: 60
gitlab_api_check_retries: 10
gitlab_api_check_delay: 15
gitlab_reconfigure_async: 3600
gitlab_reconfigure_poll: 15
gitlab_reconfigure_delay: 5
gitlab_api_unreachable_msg: 'Unable to reach GitLab API at {{ gitlab_external_url_computed }}. Verify connectivity, credentials, or TLS configuration.'
gitlab_default_status_codes:
  project_create: [200, 201]
  runner_create: [200, 201]
  project_runners_list: [200]
  runner_delete: [202, 204]
  project_search: [200]
  api_version: [200, 401]
gitlab_api_ready_failure_msg: 'Failed to contact {{ gitlab_external_url_computed }}/api/v4/version before timeout.'
gitlab_project_search_failure_msg: 'Failed to search for project {{ gitlab_project_name }} via GitLab API.'
gitlab_project_create_failure_msg: 'Failed to create GitLab project {{ gitlab_project_name }} via API.'
gitlab_runner_token_failure_msg: 'Failed to create GitLab runner authentication token for project {{ gitlab_project_name }}.'
gitlab_root_token_name: "omnia-automation"
gitlab_root_token_expiry_days: 365

# Host prerequisites
gitlab_hosted_prereq_packages:
  - curl
  - policycoreutils
  - policycoreutils-python-utils
  - openssl
  - firewalld
  - podman
  - podman-docker

# GitLab system user
gitlab_system_user_name: "git"
gitlab_system_user_shell: "/bin/sh"
gitlab_system_user_home: "/var/opt/gitlab"
gitlab_system_user_create_home: false

# GitLab directories
gitlab_directories:
  - "/etc/gitlab"
  - "/var/opt/gitlab"
  - "/var/log/gitlab"
  - "/opt/gitlab"

# GitLab files
gitlab_initial_root_password_path: "/etc/gitlab/initial_root_password"
gitlab_root_token_file_path: "/root/.gitlab_root_token"
gitlab_root_access_file_path: "/root/.gitlab_root_access"

# Runner container
gitlab_runner_image: "docker.io/gitlab/gitlab-runner:v18.8.0"
gitlab_runner_default_image: "docker.io/library/alpine:3.23.3"
gitlab_runner_helper_image_registry: "registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper"
gitlab_runner_helper_image_version: "v18.8.0"
gitlab_runner_container_name: "gitlab-runner"
gitlab_restart_policy: "always"
gitlab_runner_description: "Omnia Hosted Runner"
gitlab_runner_tags: "omnia"
gitlab_runner_executor: "docker"
gitlab_runner_registration_token_path: "/etc/gitlab/runner-registration-token"
gitlab_runner_config_path: "/srv/gitlab-runner/config"
gitlab_runner_config_file: "{{ gitlab_runner_config_path }}/config.toml"
gitlab_runner_pull_policy: "if-not-present"
force_re_register_runner: false
gitlab_runner_cleanup_existing_project_runners: true
gitlab_runner_require_online_after_deploy: true
gitlab_runner_online_check_retries: 12
gitlab_runner_online_check_delay: 10
gitlab_runner_online_failure_msg: "No online runner is assigned to project {{ gitlab_project_name }} after deployment."

# Podman socket (Docker-compatible, used by runner)
podman_socket_path: "/run/podman/podman.sock"
docker_socket_path: "/var/run/docker.sock"

# Network
gitlab_ssh_port: 22

# GitLab certificate defaults
gitlab_cert_dir: "/root/gitlab-certs"
gitlab_ssl_dir: "/etc/gitlab/ssl"
gitlab_cert_validity_days: 825
gitlab_ca_validity_days: 3650
gitlab_ca_key_bits: 4096
gitlab_server_key_bits: 2048
gitlab_ca_subject: "/C=IN/ST=Karnataka/L=Bengaluru/O=Omnia/OU=IT/CN=Omnia Internal CA"
gitlab_additional_dns_sans: []
gitlab_additional_ip_sans: []

# GitLab password change messages
gitlab_password_change_stdout_check: "Password changed successfully"
gitlab_password_change_fail_msg: "Failed to change GitLab root password. Please check GitLab logs and try again."
gitlab_password_change_success_msg: "GitLab root password changed successfully!"

# Pipeline trigger and catalog defaults
gitlab_trigger_description: "Omnia Software Catalog Webhook"
gitlab_catalog_repo_path: "catalog_rhel.json"
gitlab_catalog_json_source: "{{ role_path }}/../../../../examples/catalog/catalog_rhel.json"

# Pipeline CI/CD variables
gitlab_pipeline_var_check_status_codes: [200, 404]
gitlab_pipeline_var_create_status_codes: [200, 201]
gitlab_pipeline_var_update_status_codes: [200, 201]
gitlab_pipeline_bs_variables:
  - key: "GITLAB_API_TOKEN"
    value: "{{ gitlab_root_token }}"
    variable_type: "env_var"
    masked: true
  - key: "BSM_API_URL"
    value: "{{ _gitlab_bsm_api_url | default('') }}"
    variable_type: "env_var"
    masked: false
  - key: "BSM_API_USERNAME"
    value: "{{ _gitlab_bs_auth_username | default('') }}"
    variable_type: "env_var"
    masked: false
  - key: "BSM_API_PASSWORD"
    value: "{{ _gitlab_bs_auth_password | default('') }}"
    variable_type: "env_var"
    masked: true
  - key: "BSM_API_CERT"
    value: "{{ _gitlab_bs_api_cert | default('') }}"
    variable_type: "env_var"
    masked: false

gitlab_bs_not_enabled_fail_msg: >
  enable_build_stream is not set to true in build_stream_config.yml.
  Set enable_build_stream to true before running the GitLab playbook.

gitlab_bs_auth_username_fail_msg: >
  Build stream auth username is empty. Run the credential utility to populate
  build_stream_auth_username before running the GitLab playbook.

gitlab_bs_auth_password_fail_msg: >
  Build stream auth password is empty. Run the credential utility to populate
  build_stream_auth_password before running the GitLab playbook.

gitlab_bs_host_ip_fail_msg: >
  build_stream_host_ip is not set in build_stream_config.yml.
  Provide the OIM IP address in build_stream_host_ip before running the GitLab playbook.

gitlab_selinux_fail_msg: >
  SELinux is currently enabled. GitLab installation requires SELinux to be disabled.
  Disable SELinux and reboot the host before running this playbook.

gitlab_sshpass_install_fail_msg: >
  Failed to install sshpass. Ensure AppStream and BaseOS repositories
  are configured and enabled on this host before running this playbook.

# Debug messages
gitlab_ca_export_path: "{{ gitlab_cert_dir }}/ca.crt"

gitlab_cert_status_msg: |
  Certificate Status:
  - CA Certificate: {{ 'Exists' if _ca_cert_stat.stat.exists else 'Missing' }}
  - CA Key: {{ 'Exists' if _ca_key_stat.stat.exists else 'Missing' }}
  - Server Certificate: {{ 'Exists' if _server_cert_stat.stat.exists else 'Missing' }}
  - Server Key: {{ 'Exists' if _server_key_stat.stat.exists else 'Missing' }}
  - Generation Needed: {{ _certs_need_generation }}
  {% if not _certs_need_generation %}
  - Certificates will be reused (idempotent operation)
  {% endif %}

gitlab_ca_export_msg:
  - "========================================"
  - "CA Certificate Exported"
  - "========================================"
  - ""
  - "Certificate path: {{ gitlab_ca_export_path }}"
  - ""
  - "Download this certificate and import it into your browser"
  - "to avoid 'Not Secure' warnings when accessing GitLab."
  - ""
  - "========================================"

# OIM API Server Configuration
oim_api_verify_ssl: true
gitlab_bs_cert_path: "/opt/omnia/build_stream_ssl/ssl/bs_cert.pem"

gitlab_deployment_complete_msg:
  - "============================================"
  - "   GitLab Hosted Mode Deployment Complete   "
  - "============================================"
  - ""
  - "Access URL: {{ gitlab_external_url_computed }}"
  - "SSH Port:   {{ gitlab_ssh_port }}"
  - "Username:   root"
  - "Password:   [CONFIGURED - See /root/.gitlab_root_access]"
  - ""
  - "Project:    {{ gitlab_project_name }}"
  - "Project ID: {{ gitlab_project_id }}"
  - "Project URL: {{ gitlab_project_url }}"
  - ""
  - "Runner Auth Token: [CONFIGURED]"
  - "Trigger Token saved to: /root/.gitlab_trigger_token"
  - ""
  - "Certificates:"
  - "- CA Certificate: {{ gitlab_cert_dir }}/ca.crt"
  - "- Server Certificate: {{ gitlab_cert_dir }}/{{ gitlab_host }}.crt"
  - "- Export for Browser: {{ gitlab_ca_export_path }}"
  - "- Certificates are reused on re-run (generated only if missing)"
  - ""
  - "Service:    {{ gitlab_ctl_command }} (start|stop|status|reconfigure)"
  - "Runner:     {{ gitlab_runner_container_name }} (Podman container, registered)"
  - ""
  - "============================================"
