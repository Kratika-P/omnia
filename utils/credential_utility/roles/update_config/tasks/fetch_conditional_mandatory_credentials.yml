# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Set conditional mandatory credentials status for conditional credentials
  ansible.builtin.set_fact:
    conditional_mandatory_credentials_status: true

- name: Notify user about conditional mandatory inputs
  ansible.builtin.debug:
    msg: "{{ conditional_mandatory_warning_msg | default('Conditional mandatory credentials will be prompted based on configuration') }}"

- name: Debug conditional mandatory credentials
  ansible.builtin.debug:
    msg: "type.value: {{ type.value }}, enable_build_stream: {{ enable_build_stream | default(false) }}"

- name: Filter conditional mandatory credentials based on condition
  ansible.builtin.set_fact:
    filtered_credentials: "{{ type.value | selectattr('condition', 'defined') | list if type.value is iterable else [] }}"

- name: Debug filtered credentials
  ansible.builtin.debug:
    msg: "filtered_credentials: {{ filtered_credentials }}"

- name: Fetch conditional mandatory credentials
  ansible.builtin.include_tasks: prompt_credentials.yml
  loop: "{{ filtered_credentials }}"
  loop_control:
    loop_var: field
  when:
    - filtered_credentials | length > 0
    - field.condition | default(false) | bool

- name: Reset mandatory credentials status
  ansible.builtin.set_fact:
    mandatory_credentials_status: false
