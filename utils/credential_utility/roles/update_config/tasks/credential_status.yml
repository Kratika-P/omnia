# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

# Initialize credential file status
- name: Check credential file status
  ansible.builtin.set_fact:
    omnia_cred_file_status: "{{ credential_files[0].file_path is file }}"
    bs_cred_file_status: "{{ credential_files[1].file_path is file }}"
    skipped_optional_credentials: >-
      {{ skipped_optional_credentials | default([]) }}

# Username: prompt if field exists, value is empty, credential type is active
# Skip if username was previously skipped (in skip list)
- name: Initialize username status
  ansible.builtin.set_fact:
    username_status: >-
      {{
        field.username is defined and
        field.username is not search('switch') and
        field.username not in
          (skipped_optional_credentials | default([])) and
        (
          ((field.file is not defined or
            field.file != credential_files[1].file_path) and
           (vars[field.username] is not defined or
            vars[field.username] == "" or
            (vars[field.username] | length == 0)) and
           (mandatory_credentials_status or
            conditional_mandatory_credentials_status or
            optional_credentials_status))
          or
          ((field.file is defined and
            field.file == credential_files[1].file_path) and
           (vars['build_stream_auth_username'] is not defined or
            vars['build_stream_auth_username'] == "" or
            (vars['build_stream_auth_username'] | length == 0)))
        )
                                                                                       }}

# Password logic:
#   mandatory/conditional_mandatory: always prompt if password is empty
#   optional: prompt if username has value or will be prompted
#   build_stream: handle via separate credential file path
- name: Initialize password status
  ansible.builtin.set_fact:
    password_status: >-
      {{
        field.password is defined and
        field.password is not search('switch') and
        (
          ((field.file is not defined or
            field.file != credential_files[1].file_path) and
           (vars[field.password] is not defined or
            vars[field.password] == "" or
            (vars[field.password] | length == 0)) and
           (
             (mandatory_credentials_status | default(false) | bool or
              conditional_mandatory_credentials_status |
              default(false) | bool)
             or
             (optional_credentials_status | default(false) | bool and
              field.username is defined and
              ((vars[field.username] is defined and
                vars[field.username] != "") or
               (username_status | default(false) | bool)))))
          or
          ((field.file is defined and
            field.file == credential_files[1].file_path) and
           (vars['build_stream_auth_password_hash'] is not defined or
            vars['build_stream_auth_password_hash'] == "" or
            (vars['build_stream_auth_password_hash'] | length == 0)))
        )
      }}

# Track skipped optional credentials to avoid re-prompting
- name: Add skipped optional credentials to skip list
  ansible.builtin.set_fact:
    skipped_optional_credentials: >-
      {{ (skipped_optional_credentials | default([])) +
         [field.username] }}
  when:
    - field.username is defined
    - optional_credentials_status | default(false) | bool
    - username_status | default(false) | bool
    - vars[field.username] is not defined or
      vars[field.username] == ""

# Reset credential status after processing
- name: Reset credentials status
  ansible.builtin.set_fact:
    mandatory_credentials_status: false
    conditional_mandatory_credentials_status: false
    optional_credentials_status: false
    username_status: false
    password_status: false
  when: reset_status | default(false)

