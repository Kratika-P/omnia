# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

# Initialize credential file status
- name: Check credential file status
  ansible.builtin.set_fact:
    omnia_cred_file_status: "{{ credential_files[0].file_path is file }}"
    bs_cred_file_status: "{{ credential_files[1].file_path is file }}"

# Initialize username status based on field definition and current values
- name: Initialize username status
  ansible.builtin.set_fact:
    username_status: true
  when:
    - field.username is defined
    - field.username is not search('switch')
    - >-
      (field.file is not defined or field.file != credential_files[1].file_path) and
      ((vars[field.username] is not defined or vars[field.username] == "" or (vars[field.username] | length == 0)) and
       (mandatory_credentials_status or conditional_mandatory_credentials_status))
      or
      (field.file is defined and field.file == credential_files[1].file_path) and
      (vars['build_stream_auth_username'] is not defined or vars['build_stream_auth_username'] == "" or
      (vars['build_stream_auth_username'] is defined and (vars['build_stream_auth_username'] | length == 0)))

# Initialize password status based on field definition and current values
- name: Initialize password status
  ansible.builtin.set_fact:
    password_status: true
  when:
    - field.password is defined
    - field.password is not search('switch')
    - >-
      (field.file is not defined or field.file != credential_files[1].file_path) and
      ((vars[field.password] is not defined or vars[field.password] == "" or (vars[field.password] | length == 0)) and
       (mandatory_credentials_status or conditional_mandatory_credentials_status))
      or
      (field.file is defined and field.file == credential_files[1].file_path) and
      (vars['build_stream_auth_password_hash'] is not defined or vars['build_stream_auth_password_hash'] == "" or
      (vars['build_stream_auth_password_hash'] is defined and (vars['build_stream_auth_password_hash'] | length == 0)))

# Reset credential status after processing
- name: Reset credentials status
  ansible.builtin.set_fact:
    username_status: false
    password_status: false
  when: reset_status | default(false)
